#!/usr/bin/env python
# coding=utf8
import sys
import os
import unittest

sys.path = ['./'] + sys.path

from annotator.annotator import AnnoDoc
from annotator.geoname_annotator import GeonameAnnotator
from annotator.loader import HealthMapFileLoader
import logging
logging.getLogger('annotator.geoname_annotator').setLevel(logging.ERROR)

class GeonameAnnotatorTest(unittest.TestCase):


    def test_chicago(self):

        annotator = GeonameAnnotator()

        text = 'I went to Chicago.'
        doc = AnnoDoc(text)
        doc.add_tier(annotator)

        self.assertEqual(doc.text, text)
        self.assertEqual(len(doc.tiers['geonames'].spans), 1)
        self.assertEqual(doc.tiers['geonames'].spans[0].text, "Chicago")
        self.assertEqual(doc.tiers['geonames'].spans[0].label, "Chicago")
        self.assertEqual(doc.tiers['geonames'].spans[0].start, 10)
        self.assertEqual(doc.tiers['geonames'].spans[0].end, 17)

    def test_mulipart_names(self):

        annotator = GeonameAnnotator()

        text = 'I used to live in Seattle, WA'
        doc = AnnoDoc(text)
        doc.add_tier(annotator)

        self.assertEqual(doc.text, text)
        #print doc.tiers['geonames'].spans
        self.assertEqual(len(doc.tiers['geonames'].spans), 1)
        self.assertEqual(doc.tiers['geonames'].spans[0].text, "Seattle, WA")

    def test_mulipart_names2(self):

        annotator = GeonameAnnotator()

        text = 'I live in Taipei, Taiwan'
        doc = AnnoDoc(text)
        doc.add_tier(annotator)

        self.assertEqual(doc.text, text)
        self.assertEqual(len(doc.tiers['geonames'].spans), 1)
        self.assertEqual(doc.tiers['geonames'].spans[0].text, "Taipei, Taiwan")

    def test_mulipart_names3(self):

        annotator = GeonameAnnotator()

        text = 'England, France, Germany and Italy are countries in Eurpoe'
        doc = AnnoDoc(text)
        doc.add_tier(annotator)

        self.assertEqual(doc.text, text)
        self.assertEqual([
            span.text
            for span in doc.tiers['geonames'].spans
        ], [
            'England', 'France', 'Germany', 'Italy'
        ])

    def test_bug_causing_sentence(self):
        text = u"""
        In late June 2012, an increase in cases of prolonged fever for â‰¥3 days
        was reported from the Vanimo General Hospital in
        Vanimo, Sandaun Province.
        """
        annotator = GeonameAnnotator()
        doc = AnnoDoc(text)
        doc.add_tier(annotator)

    def test_slow_article(self):
        from datetime import datetime, timedelta
        start = datetime.utcnow()
        doc = AnnoDoc(u"""
        Published Date: 2014-08-25 19:24:03 Subject: PRO/AH/EDR> Ebola virus disease - West Africa (138): new drugs, prevention, alerts, more Archive Number: 20140825.2721852 EBOLA VIRUS DISEASE - WEST AFRICA (138): NEW DRUGS, PREVENTION, ALERTS, MORE **************************************************************************** A ProMED-mail post http://www.promedmail.org ProMED-mail is a program of the International Society for Infectious Diseases http://www.isid.org In this update: [1] New drugs [2] Prevention, suspected cases [3] Alerts [4] Media reports ****** [1] New drugs ZMapp USA ----- 25 Aug 2014: One of 3 African doctors infected with EVD and treated with the experimental drug ZMapp has died in Monrovia, Liberia's Information Minister Lewis Brown said on Mon [25 Aug 2014]. Asked to confirm the death of doctor Abraham Borbor, Brown said: "That is correct. He died yesterday [24 Aug 2014]." (Reuters Reporting by Emma Farge; Editing by Daniel Flynn) http://in.mobile.reuters.com/article/idINL5N0QV21A20140825?irpc=932 T-705 Japan ------------- 25 Aug 2014: Japan to name criteria before offering unapproved EVD drug. Japan could offer an unapproved drug under certain circumstances to help treat the deadly ebolavirus, Reuters said. "Medical professionals could make a request for T-705 in an emergency even before a decision by the World Health Organization (WHO)," Chief Cabinet Secretary Yoshihide Suga said. "In that case, we would like to respond under certain criteria." Tokyo will cooperate with the WHO and is ready to make an international contribution. Japan's Fujifilm Holdings Corp and US's MediVector are in talks with the US Food and Drug Administration to submit an application to expand the use of the influenza drug T-705, or favipiravir, as a treatment for EVD. http://investmentwatchblog.com/ebola-cure-japan-ready-to-offer-experimental-drug/#bd3TYhFSat70tJ0r.99 -- 25 Aug 2014: It is not clear whether T-705 (or Avigan) will actually work against EVD, and no monkey or human trials of the drug have been done, the BBC's Rupert Wingfield-Hayes in Tokyo reports. T-705 was developed by Japan's Toyama Chemicals company for use against new strains of influenza. It was approved by the Japanese government earlier this year [2014, without any human trials? - Mod.JW]. A company spokesman says the firm believes the similarity between flu viruses and ebolaviruses means Avigan could be effective [They are both single-stranded negative-sense RNA (ribonucleic acid) viruses. - Mod.JW]. http://www.bbc.com/news/world-africa-28925491 WHO meeting ------------ 24 Aug 2014: The World Health Organization is scheduled to hold a meeting in Geneva next week with more than 100 experts, including 20 from West Africa, to discuss potential therapies and vaccines for the ebolavirus and explore ways to expedite clinical trials and ramp up production of the most promising treatments. The meeting should be sure to consider the use of drugs that are already approved for other diseases and are readily available. There are currently no approved drugs to treat infection with ebolaviruses and only a handful of potential drug therapies in the very earliest stages of testing in humans or animals, with little likelihood that they could be produced on a large scale any time soon. The new proposal would fill the gap by using drugs that have already been approved to treat other diseases and repurposing them to treat EVD as well. This approach is well worth pursuing, given the crisis; 2 broad categories of drugs are being mentioned. Existing drugs that seek to disable the viruses responsible for other diseases, for example, might conceivably disable ebolaviruses. And drugs that temper the body's response to other diseases by reducing severe inflammation might also dampen the often fatal inflammatory response in EVD patients. An advantage to using existing drugs is that they have been tested for safety and are often available in large quantities and produced as cheaper generics. If they could be offered to infected people in Africa, it might encourage patients to go get treatment instead of hiding from the authorities, and it might bolster the confidence of health care workers who are fleeing from hospitals in droves. There are also disadvantages. Just because a drug is effective against one disease does not mean it would work against EVD. It is possible that some drugs might actually harm EVD patients by making their infection worse or by causing severe side effects. One expert warns that EVD infection progresses rapidly within the body and that a drug that helps on Day 2 might become harmful by Day 7. That is why even approved drugs should be administered in clinical trials to determine whether they work against EVD. Though it would not be easy to conduct such trials, several experts have said they think it could and should be done. The idea of using approved drugs was proposed in an Op-Ed article in The Times on 16 Aug 2014; 30 respected clinical investigators and epidemiologists around the world are on record as supporting the article. Other experts have expressed reservations and have called for drug tests in nonhuman primates 1st. Even those who have backed the use of existing drugs because "desperate situations justify desperate measures" have stressed that there needs to be some evidence a drug might work. Beyond this, the primary need right now is supportive care, like keeping patients hydrated, which allows many to recover even without a drug treatment. This requires that hospitals and clinics have isolation units for the patients and protective gear for doctors and nurses to prevent the spread of the virus. Once such facilities exist, it should be possible to compare one group of patients given standard supportive care with another group given supportive care plus a drug that might help them. -- Communicated by: ProMED-mail <promed@promedmail.org> ****** [2] Prevention, suspected cases Bolivia ------- 24 Aug 2014: Authorities say they are investigating a 1st potential case of EVD in Bolivia. The patient, whose name and age were not given, had made stopovers in several cities in Africa, Santa Cruz health service manager Roberto Torres told Oxigeno online. "Yesterday [23 Aug 2014], we had a report from a private hospital on an Indian [national] who is being treated for fever, diarrhoea and vomiting," he said. The health ministry in South America's poorest nation just 10 days ago set rules on early detection of potentially infected people. http://www.sbs.com.au/news/article/2014/08/24/bolivia-patient-isolated-ebola-check Guinea-Bissau -------------- 25 Aug 2014: Government accompanies closure of borders Bissau - A delegation composed of the Ministers of Health, Home Affairs and National Defence completed a tour of the interior of the country, in the eastern and southern borders of Guinea-Bissau. http://jornaldigital.com/noticias.php?noticia=43033 [in Portuguese] India ----- 25 Aug 2014: EVD alert as flight with over 100 passengers from Liberia headed for Mumbai. "We have been told that 116 passengers are suspected of EVD exposure," BMC's [Brihanmumbai Municipal Corporation] additional municipal commissioner Sanjay Deshmukh said. ... "Right now, we are focusing on creating beds for suspected cases. Isolation chambers are not immediately possible." ... In terms of protection to the medical staff who will handle suspected or confirmed EVD patients, the BMC already has as many as 600 body suits for staffers and doctors to wear. (AP) http://indianexpress.com/article/india/maharashtra/bmc-on-alert-after-receiving-report-of-flight-transporting-over-100-liberia-passengers-exposed-to-ebola/ Senegal -------- 25 Aug 2014: Tom Frieden, director of the U.S. Centers for Disease Control and Prevention [CDC], was supposed to fly to West Africa on Mon [25 Aug 2014] to gauge the effects of the world's worst EVD outbreak. Then, his flight was canceled. Brussels Airlines was forced to halt flights to the affected region after Senegal's refusal this weekend to allow the Belgium-based carrier to touch down in Dakar for crew changes. ... The flight situation also has proven a burden for the WHO delegation now visiting Freetown. The team members were supposed to fly out on Brussels Air. On Monday [25 Aug 2014], there was word that the airline was negotiating with another country to access so crew changes could be made. Maybe flights would resume. But, in the meantime, the WHO officials were grounded. They hoped a small UN plane might become available. http://www.washingtonpost.com/world/africa/alarm-grows-as-ebola-outbreak-spurs-more-flight-cancellations-border-closures/2014/08/25/87e6d020-2c66-11e4-994d-202962a9150c_story.html -- Communicated by: ProMED-mail <promed@promedmail.org> ****** [3] Alerts Ghana ----- Organisers of the Big Brother Africa competition have allegedly rejected the candidates selected to represent Ghana at the contest. ... Sources at Endemol, producers of the BBA show, said the 4 candidates who made it through the selection stage in Ghana were rejected because of the EVD scare in the West African sub-region. An official revealed that fresh auditions are being held to select new Ghanaian candidates for the popular TV reality show of the continent. The new audition is only opened to Ghanaian nationals living in South Africa as a precautionary measure. ... It is expected that the same thing will be done for candidates from all of West Africa, especially countries where the Ebola virus disease has been recorded. http://www.faceofmalawi.com/2014/08/big-brother-africa-rejects-west-african-candidates-over-ebola-scare/#sthash.WjDLsGxe.dpuf [There have been no reports of EVD in Ghana, so the TV producers are needlessly worried. - Mod.JW] Malawi ------ 25 Aug 2014: Malawi police arrested 52 Ethiopians. Residents worried about ebolavirus being carried by Ethiopians. http://www.faceofmalawi.com/2014/08/malawi-police-arrested-52-ethiopians-residents-worried-about-ebola-virus-being-carried-by-ethiopians/#sthash.MFzDPezE.dpuf [There have been no reports of EVD in Ethiopia, so Malawi is needlessly worried. - Mod.JW] -- Communicated by: ProMED-mail <promed@promedmail.org> ****** [4] Media reports Nigeria ------- 23 Aug 2014: First Consultant Hospital speaks on Sawyer The management of First Consultant Hospital, Obalende, Lagos State has spoken on late Liberian-American Patrick Sawyer, who brought the Ebola virus disease to Nigeria, saying it took necessary measures in line with international standards to prevent the spread of the virus. In a press statement, it said in spite of denial by Sawyer, who described himself as a Senior Diplomat from Liberia, adequate measures were taken, which included isolating the patient, implementing barrier nursing and contacting the Lagos State Ministry of Health and the Federal Ministry of Health. It said, "A 40-year-old gentleman came into the hospital with symptoms suggestive of malaria (fever, headache, extreme weakness) on Sun 20 Jul 2014. He was fully conscious and gave us his clinical history and told us he is a Senior Diplomat from Liberia. Laboratory investigations confirmed malaria, whilst other tests for HIV, hepatitis B and C were negative. He was admitted, and treatment commenced. However, due to the fact that he was not responding to treatment but rather was developing haemorrhagic symptoms, we further questioned him. He denied having been in contact with any persons with EVD at home, in any hospital, or at any burial." Having treated [him] for malaria with no significant improvement, the management carried out tests for possible infectious haemorrhagic disease, especially EVD, based on the fact that he was from Liberia, which had recently witnessed an EVD outbreak. It said: "We refused for him to be let out of the hospital in spite of intense pressure, as we were told that he was a senior ECOWAS official and had an important role to play at the ECOWAS convention in Calabar, Cross River State. The initial test results from LUTH [Lagos University Teaching Hospital] laboratory indicated a signal of possible ebolavirus but required confirmation. We then took the further step of reaching out to Senior Officials in the office of the Secretary of Health of the United States of America, who promptly assisted us with contacts at the Centres for Disease Control [and Prevention] and the World Health Organization Regional Laboratory Centre in Senegal." "Working jointly with the State, Federal Agencies and International Agencies, we were able to obtain confirmation of ebolavirus (Zaire strain), (WHO Regional Center Lab-Senegal/Redeemers [University] lab/LUTH Laboratory). He afterwards died on 25 Jul 2014 at about 6.50 am. All agencies were promptly notified, and, in consultation with WHO, the Regional Ebola Virus Disease Centre in Conakry, Guinea and Best Practices, we commenced temporary shut down of the hospital with immediate evacuation of in-house patients. The appropriate professional removal of the body and its incineration under WHO guidelines, witnessed by all appropriate agencies, was carried out. In keeping with WHO guidelines, the hospital has been shut down briefly as a full decontamination exercise is currently in progress. We hope that by our action of preventing this gentleman from being extracted from our hospital and traveling to Calabar, we have been able to prevent the spread of Ebola virus disease in Nigeria." http://www.punchng.com/news/ebola-first-consultant-hospital-speaks-on-late-sawyer 24 Aug 2014: Striking doctors will resume work In Nigeria, striking doctors will resume work on Mon [25 Aug 2014] following an intervention by Senate President David Mark, according to Dr. Lawan Musa, leading member of the Nigerian Medical Association (NMA). Musa says Mark promised the group that the government was willing to address their concerns. Officials of the NMA say the 2-month old strike was suspended due to the EVD emergency, while negotiations with the government continue. ... "This strike started even before the EVD [outbreak], and immediately the Nigeria Medical Association ordered all doctors in the states that were affected [to go back to work]; precisely Lagos and Anambra [states] were the 1st to be given the order that they should attend to issues pertaining to EVD," said Musa. "There were a lot of doctors that were part of the control team despite the ongoing strike." http://m.voanews.com/a/nigerian-doctors-suspend-strike/2426757.html Contact tracing failing ------------- 25 Aug 2014: ... There's no solid number of how many contacts have gone missing. Petersen said the CDC arrived at the 40-60 percent number because in some communities, each sick person has only listed an average of 2 contacts, and households commonly have 5 or 6 people. Mirkovic, an officer with the CDC's epidemic intelligence service, said when she and her team felt patients weren't being honest, they would try to get information from neighbors or community leaders. Sometimes that helped, and sometimes it didn't. "Unfortunately, there's nothing we can do," she said. "We can't force them" to give contacts. The World Health Organization estimates that 10 percent of contacts will go on to develop symptoms of EVD. Occasionally, some of these EVD cases go missing as well. Mirkovic, who left Guinea at the end of July [2014], said she felt that the situation might improve as health care workers gain more trust in the community. But there's another problem with that: the availability of workers to follow up with contacts. For example, in Sierra Leone, there are 2000 contacts that need following, but the group Doctors without Borders [MSF] says they've only been able to follow up about 200 of them. The group's teams in Sierra Leone and Liberia are "stretched to the breaking point," as the epidemic is "spiraling out of control," the group wrote in a press release. http://www.cnn.com/2014/08/25/health/ebola-contact-tracing/?c=&page=0 -- Communicated by: ProMED-mail <promed@promedmail.org> [The stories about Ghana and Malawi reveal basic misunderstanding about which countries are currently known to be infected by EVD. ProMED thanks Ryan McGinnis http://bigstormpicture.com and Stephanie Ballatore Holland Lins <tefalins@hotmail.com> for their contributions. - Mod.JW A HealthMap/ProMED-mail map can be accessed at: http://healthmap.org/promed/p/8854.] See Also Ebola virus disease - West Africa (137): Sierra Leone, decontamination, more Ebola virus disease - West Africa (136): Nigeria, Sierra Leone, Liberia, more 20140823.2717179 Ebola virus disease - West Africa (135): WHO, Nigeria, recovery, more 20140822.2715257 Ebola virus disease - West Africa (134): Americans cured, more 20140821.2712004 Ebola virus disease - West Africa (133): WHO, Nigeria, Liberia, CDC, more 20140820.2708740 Ebola virus disease - West Africa (132): WHO, SOS, Liberia, Nigeria, more 20140819.2705249 Ebola virus disease - West Africa (131): WHO exit screening, Liberia, more 20140818.2701641 Ebola virus disease - West Africa (130): Nigeria, Liberia, more: corr. 20140818.2701063 Ebola virus disease - West Africa (130): Liberia, more 20140817.2698701 Ebola virus disease - West Africa (129): Nigeria, prevention, more 20140816.2696764 Ebola virus disease - West Africa (128): WHO, toll, Liberia, drug, more 20140816.2694748 Ebola virus disease - West Africa (127): Guinea, screening, more 20140815.2691736 Ebola virus disease - West Africa (126): WHO, Sierra Leone, index case, more 20140814.2688054 Ebola virus disease - West Africa (125): WHO, Nigeria, USA fear, CDC, more 20140812.2680534 Ebola virus disease - West Africa (124): WHO, Nigeria, USA fear, CDC, more 20140812.2682604 Ebola virus disease - West Africa (123): Sierra Leone, more, CDC 20140810.2677007 Ebola virus disease - West Africa (122): Sierra Leone lessons learned 20140809.2675385 Ebola virus disease - West Africa (121): WHO, Nigeria emergency, more 20140809.2674333 Ebola virus disease - West Africa (120): MSF, Sierra Leone, drug, PAHO, aid 20140808.2673098 Ebola virus disease - West Africa (119): WHO -- International Emergency 20140808.2671013 Ebola virus disease - West Africa (118): Liberia, Sierra Leone, CDC, drugs, more 20140807.2669718 Ebola virus disease - West Africa (117): WHO, Nigeria, more 20140806.2666073 Ebola virus disease - West Africa (116): Morocco NOT, Nigeria, bushmeat, more 20140805.2663054 Ebola virus disease - West Africa (115): Morocco ex Liberia, Nigeria appeal 20140805.2661180 Ebola virus disease - West Africa (114): USA (NYC) susp. more 20140804.2659805 Ebola virus disease - West Africa (113): Nigeria 20140804.2658338 Ebola virus disease - West Africa (112): WHO, USA case repatriated, more 20140803.2656749 Ebola virus disease - West Africa (111): WHO, Sierra Leone, vaccine, screening 20140802.2655022 Ebola virus disease - West Africa (110): WHO, Sierra Leone, Liberia, MSF, alerts 20140801.2652884 Ebola virus disease - West Africa (109): Sierra Leone, MOH statement 20140801.2652930 Ebola virus disease - West Africa (108): WHO, situation, Guinea-Bissau alert 20140731.2650008 Ebola virus disease - West Africa (107): WHO, China & UK NOT, Nigeria, airlines 20140730.2646645 Ebola virus disease - West Africa (104): WHO, Nigeria, Togo alert, Sierra Leone 20140727.2638658 Ebola virus disease - West Africa (102): Nigeria, Sierra Leone, drugs & vaccine 20140726.2636858 Ebola virus disease - West Africa (101): Nigeria ex Liberia, WHO, Sierra Leone 20140726.2636095 Ebola virus disease - West Africa (100): Cote d'Ivoire,Tanzania, Nigeria alerts 20140724.2633437 Ebola virus disease - West Africa (99): WHO, Sierra Leone, Liberia 20140724.2632442 Ebola virus disease - West Africa (98): Nigeria susp, alert 20140724.2632831 Ebola virus disease - West Africa (97): Sierra Leone, Liberia, tests 20140723.2630441 Ebola virus disease - West Africa (95): FAO alert, Sierra Leone 20140722.2626215 Ebola virus disease - Congo DR: susp 20140721.2624831 Ebola virus disease - West Africa (94): Sierra Leone 20140720.2623966 Ebola virus disease - West Africa (93): Sierra Leone, WHO underfunded 20140719.2622727 Ebola virus disease - West Africa (92): Sierra Leone, drugs, EU disease ctr. 20140718.2620802 Ebola virus disease - West Africa (91): WHO, Guinea,Sierra Leone,Liberia, border 20140717.2618525 Ebola virus disease - West Africa (90): Sierra Leone, Ghana meeting, historical 20140716.2615640 Ebola virus disease - West Africa (89): WHO update, Sierra Leone, Liberia, risk 20140715.2613043 Ebola virus disease - West Africa (88): WHO, Liberia, prevention, challenges 20140713.2607118 Ebola virus disease - West Africa (87): Liberia, Sierra Leone, MSF, drugs, vaccine 20140712.2605570 Ebola virus disease - West Africa (86): WHO, UNSC, ECOWAS, Guinea, Liberia 20140711.2603448 Ebola virus disease - West Africa (85): Guinea, Liberia, region 20140710.2601330 Ebola virus disease - West Africa (84): WHO update 20140708.2596192 Ebola virus disease - West Africa (83): Ghana susp, Guinea, S. Leone, Liberia 20140708.2593018 Ebola virus disease - West Africa (82): Guinea, prevention, Tanzania, UK 20140706.2591433 Ebola virus disease - West Africa (81): Guinea, Sierra Leone, Liberia, overseas 20140705.2589463 Ebola virus disease - West Africa (80): WHO update, meeting 20140704.2587114 Ebola virus disease - West Africa (79): Guinea, Nigeria prevention, drug testing 20140703.2586162 Ebola virus disease - West Africa (78): Guinea, Sierra Leone, Liberia 20140702.2583396 Ebola virus disease - West Africa (77): WHO, meeting, Sierra Leone, Liberia 20140701.2579682 Ebola virus disease - West Africa (74): CDC summary 20140626.2566502 Ebola virus disease - West Africa (73): WHO update, Sierra Leone 20140625.2566397 Ebola virus disease - West Africa (72): WHO update 20140624.2562337 Ebola virus disease - West Africa (71): Guinea, Sierra Leone, Nigeria serology 20140622.2558446 Ebola virus disease - West Africa (70): Sierra Leone, Liberia, travel advice 20140621.2556770 Ebola virus disease - West Africa (69): Guinea, Sierra Leone, region 20140621.2555351 Ebola virus disease - West Africa (68): Liberia, One Health approach 20140619.2553035 Ebola virus disease - West Africa (67): WHO update, Liberia, Sierra Leone 20140618.2550323 Ebola virus disease - West Africa (66): Liberia (Monrovia), Sierra Leone 20140617.2547352 Ebola virus disease - West Africa (63): Sierra Leone 20140613.2538970 Ebola virus disease - West Africa (58): Sierra Leone, challenges 20140607.2526192 Ebola virus disease - West Africa (57): WHO update, challenges 20140607.2525234 Ebola virus disease - West Africa (56): Sierra Leone, Liberia, WHO 20140604.2518983 Ebola virus disease - West Africa (55): MSF report, Sierra Leone 20140603.2517388 Ebola virus disease - West Africa (54): WHO update, Sierra Leone 20140603.2515262 Ebola virus disease - Guinea (04): WHO update, Conakry conf., alerts 20140328.2364547 Ebola virus disease - Liberia ex Guinea: susp. alert, RFI 20140326.2360265 Ebola virus disease - Guinea (03): WHO update, travel health advisories 20140326.2359361 Ebola virus disease - Guinea (02): bat eating banned 20140326.2359281 Ebola virus disease - West Africa: Guinea, Zaire ebolavirus suspected 20140322.2349865 Ebola - Sierra Leone: susp. alert, RFI 20140322.2349697 Undiagnosed viral hemorrhagic fever - Guinea (02): Ebola conf. 20140322.234969 Undiagnosed viral hemorrhagic fever - Guinea: (NZ) RFI 20140319.2342420 .................................................sb/jw/msp/jw
        """)
        doc.add_tier(GeonameAnnotator())
        self.assertTrue(
            (datetime.utcnow() - start) < timedelta(seconds=12),
            "The article took too long to process."
        )
    
    def test_northeast(self):
        doc = AnnoDoc(u"""
         Instead, a novel virus was isolated from a patientâ€™s blood. Since March 2010, there were frequent reports of a unique group of hospitalized patients who presented with clinical symptoms similar to those of SFTS in Central and Northeast China (Fig. 1). On the basis of data from a primary investigation in 2009, an enhanced surveillance was implement- ed in selected provinces in China to further in- vestigate the cause and epidemiologic character- istics of SFTS. Here we describe the discovery and characterization of a novel phlebovirus in the Bunyaviridae family, designated SFTS bunyavirus (SFTSV), which is associated with SFTS. We also discuss the clinical manifestations of SFTS and the epidemiologic investigations. Methods Case Definition and Surveillance Methods Since 2009, we have implemented an active sur- veillance program in selected areas in Hubei and Henan provinces to identify patients with SFTS. The syndrome was characterized by acute fever (temperatures of 38Â°C or more) and thrombocyto- penia (platelet count, <100,000 per cubic millime- ter) of unknown cause.2 We collected blood sam- ples from hospitalized patients whose symptoms fulfilled the criteria of the case definition. We excluded patients whose symptoms fit these crite- ria but who had other clinical or laboratory-con- firmed diagnoses. We defined a laboratory-confirmed case as meeting one or more of the following criteria: the isolation of SFTSV from the patientâ€™s serum, the detection of SFTSV RNA in the patientâ€™s se- rum during the acute phase of the illness, or the detection of seroconversion or an elevation by a factor of four in serum IgG antibodies against SFTSV on enzyme-linked immunosorbent assay (ELISA), indirect immunof luorescence assay, or neutralization testing in serum obtained during the convalescent phase. If possible, we collected serum samples within 2 weeks after the onset of fever and again during the convalescent phase. We also collected serum samples from 200 patient- matched healthy persons living in the same areas and during the same time period. The research protocol was approved by the human bioethics committee of the Chinese Center for Disease Con- trol and Prevention, and all participants provided written informed consent. Isolation of an Unknown Pathogen In June 2009, a blood sample in heparin antico- agulant was obtained on day 7 after the onset of illness from a patient from Xinyang City in Henan Province. Because the cause of the illness was un- known, we designed a strategy to isolate the patho- gen by inoculating multiple cell lines susceptible to both viral and rickettsial agents, including hu- man cell line HL60; animal cell lines DH82, L929, Vero, and Vero E6; and tick cell line ISE6. The pa- tientâ€™s white cells were used to inoculate cell mono- layers. The cells were cultured at 37Â°C in a 5% carbon dioxide atmosphere with media changes twice a week. In 2010, we used a related strategy to isolate an additional 11 strains of the virus by inoculation of serum or homogenized white cells onto Vero cells. Electron Microscopy A DH82-cell monolayer that was infected with SFTSV in T25 flasks was fixed for transmission electron microscopy with Ito solution, as de- scribed previously.3 Ultrathin sections were cut on a Reichertâ€“Leica Ultracut S ultramicrotome, stained with lead citrate and examined in a Phil- ips 201 or CM-100 electron microscope at 60 kV. Negative-stain electron microscopy was performed on virions purified from a clarified culture super- natant of infected Vero cells concentrated by a factor of 100.4,5 Genetic Analysis For the first SFTSV isolate, formalin-fixed cell cul- ture was used to extract viral RNA using a High Pure FFPE RNA Micro Kit (Roche Applied Sci- ence). The virus was sequenced with the use of the restriction-fragmentâ€“length-polymorphism assay with amplified complementary DNA, as described previously.6 For the remaining 11 strains of the virus, the whole genomes were sequenced with the use of the sequence-independent, single-primer amplification (SISPA) method.7 The 5' and 3' ter- minals of viral RNA segments were determined with a RACE Kit (Invitrogen). Phylogenetic analy- ses were performed with the neighbor-joining method with the use of the Poisson correction and complete deletion of gaps. Neutralization Assay For microneutralization testing, serial dilutions of serum samples were mixed with an equal vol- ume of 100 median tissue-culture infectious dos- es of SFTSV (strain HB29) and incubated at 37Â°C for 1.5 hours. The mixture was then added to a 96-well plate containing Vero cells in quadrupli- cate. The plates were incubated at 37Â°C in a 5% carbon dioxide atmosphere for 12 days. Viral in- fection was detected on specific immunofluores- cence assays in serum samples from patients with laboratory-confirmed infection. The end-point ti- ter was expressed as the reciprocal of the highest dilution of serum that prevented infection. Polymerase Chain Reaction RNA that was extracted from serum, whole blood, or homogenized arthropods was amplified with the use of a one-step, multiplex real-time reverse- transcriptase polymerase chain reaction (RT-PCR) with primers for SFTSV (Qiagen). The cutoff cycle- threshold value for a positive sample was set at 35 cycles. Nested RT-PCR and sequencing were used to verify samples from which only one ge- nomic segment was amplified. Virus Isolation The first SFTSV (strain DBM) was isolated from a 42-year-old man from Henan Province. A month after inoculation of cell monolayers with white cells obtained from the patient, virus-induced cellular changes visible on light microscopy (cyto- pathic effect) were observed in DH82 cells but not in the other cell lines. The morphologic features of infected DH82 cells changed from round mono- cytes to an elongated shape, which had granular particles in the cytoplasm (Fig. 2A). After several passages in culture, the cytopathic effect usually appeared on day 4 after inoculation of a fresh monolayer. Subsequently, 11 additional strains of the virus were isolated from serum samples ob- tained from patients during the acute phase of illness in six provinces with the use of Vero cells (Table 1 in the Supplementary Appendix, available with the full text of this article at NEJM.org). SFTSV can infect a variety of cells, including L929, Vero E6, Vero (Fig. 2B), and DH82 cells, but it re- sulted in the cytopathic effect only in DH82 cells. The viral particles were spheres with a diameter of 80 to 100 nm. Negative-stain electron microscopy of SFTSV particles that were purified from the su- pernatants of infected Vero cells revealed complex surface projections (Fig. 2C). Transmission electron microscopy revealed viral particles in the DH82-cell cytoplasm. The virions were observed inside vacu- oles, presumably in the Golgi apparatus (Fig. 2D). Partial sequences were obtained from the first isolated virus strain DBM, and the complete ge- nomes of 11 additional human isolates of SFTSV were determined. (GenBank accession numbers are provided in Table 1 in the Supplementary Ap- pendix.) All isolates including strain DBM were closely related (96% homology of nucleotide se- quences for all segments). The terminals of the three genomic segments of SFTSV were found to be similar to counterparts in other phlebovirus- es.8 The L segment contains 6368 nucleotides with one open reading frame encoding 2084 amino acids. The M segment contains 3378 nu- cleotides with one open reading frame encoding 1073 amino acid precursors of glycoproteins (Gn and Gc). The S segment contains 1744 nucleo- tides of ambisense RNA encoding two proteins, the N and NSs proteins, in opposite orientations, separated by a 62-bp intergenic region. Phylogenetic trees based on partial or complete viral genomic sequences of L, M, and S segments from strains DBM, HN6, and HB29 showed that SFTSV was related to prototypic viruses of the five genera of Bunyaviridae (Fig. 1 in the Supple- mentary Appendix). Among the genera orthobun- yavirus, hantavirus, nairovirus, phlebovirus, and tospovirus, SFTSV belongs to the phlebovirus genus8 but was more distantly related to proto- typic viruses in the other four genera. To verify this finding, we carried out a phylogenetic analy- sis, using complete deduced amino acid sequenc- es coding for RNA-dependent RNA polymerase, glycoproteins (Gn and Gc), and N and NSs pro- teins of SFTSV (strains HB29, HN6, AN12, LN2, JS3, and SD4) from six provinces in China, as com- pared with the other known phleboviruses (Fig. 3). The generated phylogenetic tree showed that all SFTSV isolates clustered together but were near- ly equidistant from the other two groups,9 the Sandfly fever group (Rift Valley fever virus, Punta Toro virus, Toscana virus, Massila virus, and Sandfly fever Sicilian virus) and the Uukuniemi group. This suggested that SFTSV is the proto- type of a third group in the phlebovirus genus. A comparison of the similarity of amino acid sequences provided further evidence that SFTSV is distinct from the other phleboviruses (Table 2 in the Supplementary Appendix). Both RNA- dependent RNA polymerase and glycoproteins of SFTSV are slightly more closely related to coun- terparts in Uukuniemi virus. However, N pro- teins in SFTSV and Rift Valley fever virus had 41.4% similarity. In contrast, the amino acids in NSs proteins encoded by the S segment showed a similarity of only 11.2 to 16.0% with amino acids in other phleboviruses. Serologic Analysis We evaluated seroconversion against SFTSV in pa- tients with SFTS using three different methods: immunof luorescence assay, ELISA, and microneu- tralization. We chose a cohort of 35 patients with RT-PCRâ€“confirmed SFTSV infection who had se- rum samples from both acute and convalescent phases of the illness. An elevation in the anti- body titer by a factor of four or seroconversion was observed in all 35 patients, as seen especially on microneutralization (Table 1). These results indi- cated that high levels of neutralizing antibodies were generated during the convalescent phase of the illness. An antibody titer of more than 1:25,600 on ELISA was present in 15 convalescent-phase serum samples, indicating a robust humoral im- mune response against SFTSV. Among the 35 se- ropositive samples, all SFTSV infections were confirmed on viral RNA sequencing, and 11 were confirmed on virus isolation. It is noteworthy that specific neutralizing antibodies against SFTSV persisted in some convalescent-phase serum sam- ples even 1 year after recovery. Clinical Symptoms The first patient, a 42-year-old male farmer, pre- sented with fever (temperatures of 39.2 to 39.7Â°C), fatigue, conjunctival congestion, diarrhea, abdom- inal pain, leukocytopenia, thrombocytopenia, pro- teinuria, and hematuria. Later, a unique group of hospitalized patients with acute high fever with thrombocytopenia was identified. We analyzed only 81 patients with laboratory-confirmed SFTSV infection who had a complete medical record for the clinical spectrum of SFTS. The clinical symp- toms of SFTS were nonspecific, and the major symptoms included fever and gastrointestinal symptoms. Regional lymphadenopathy was also frequently observed (Table 2). The most common abnormalities on laboratory testing were thrombo- cytopenia (95%) and leukocytopenia (86%) (Table 3). Multiorgan failure developed rapidly in most patients, as shown by elevated levels of serum ala- nine aminotransferase, aspartate aminotransfer- ase, creatine kinase, and lactate dehydrogenase. Proteinuria (in 84% of patients) and hematuria (in 59%) were also observed. Among the 171 con- firmed cases, there were 21 deaths (12%). However, it is not clear how SFTSV caused these deaths. Epidemiologic Investigation From June 2009 through September 2010, we de- tected SFTS bunyavirus RNA, specific antiviral antibodies, or both in 171 patients among 241 hospitalized patients who met the case defini- tion for SFTS2 in Central and Northeast China. These patients included 43 in Henan, 52 in Hubei, 93 in Shandong, 31 in Anhui, 11 in Jiangsu, and 11 in Liaoning provinces. In 2010, a total of 148 of 154 laboratory-confirmed cases (96%) occurred from May to July. The ages of the patients ranged from 39 to 83 years, and 115 of 154 patients (75%) were over 50 years of age. Of these 154 patients, 86 (56%) were women, and 150 (97%) were farm- ers living in wooded and hilly areas and working in the fields before the onset of disease. No SFTSV was identified on real-time RT-PCR and no anti- bodies against SFTSV were identified in serum samples that were collected from 200 patient- matched healthy control subjects in the endemic areas, from 180 healthy subjects from nonendem- ic areas, and from 54 patients with suspected hem- orrhagic fever with renal syndrome. Mosquitoes and ticks were commonly found in the patientsâ€™ home environment. However, viral RNA was not detected in any of 5900 mosquitoes tested. On the other hand, 10 of 186 ticks (5.4%) of the species Haemaphysalis longicornis that were collected from domestic animals in the areas where the patients lived contained SFTSV RNA. The viruses in the ticks were isolated in Vero cell culture, and the RNA sequences of these viruses were very closely related but not identical to the SFTSV isolated in samples obtained from the patients (data not shown). There was no epidemiologic evidence of human-to-human transmission of the virus. Discussion Although we have not fulfilled Kochâ€™s postulates for establishing a causal relationship between a mi- crobe and a disease in their entirety, our findings suggest that SFTS is caused by a newly identified bunyavirus. These data include epidemiologic, clinical, and laboratory findings and several lines of evidence that include virus isolation, viral RNA detection, and molecular and serologic analyses. SFTS has been identified in Central and Northeast China, which covers all six provinces where sur- veillance for SFTS was carried out.
         """)
        doc.add_tier(GeonameAnnotator())
        self.assertTrue(
            'Northeast' not in [span.text for span in doc.tiers['geonames'].spans]
        )

    def test_url_names(self):
        doc = AnnoDoc(u"""
        [1] Cholera - South Sudan
        Date: Sat 19 Jul 2014
        Source: Radio Tamazuj [edited]
        https://radiotamazuj.org/en/article/south-sudan-100-total-cholera-deaths
        """)
        doc.add_tier(GeonameAnnotator())
        self.assertEqual(len(doc.tiers['geonames']), 1)

    def test_for_duplicate_spans(self):
        doc = AnnoDoc(u"""
        Hidalgo in the Tezontle in Pachuca 3 in Tlaxcoapan, 4 in Mixquiahuala and 4 in Tetepango.
        
        175 cases of cholera were confirmed in La Huasteca (159 in Hidalgo, 14 in Veracruz, and 2 in San Luis Potosi) in La Huasteca area (http://en.wikipedia.org/wiki/La_Huasteca), a geographical and cultural region located in Mexico along the Gulf of Mexico that includes parts of the states of Tamaulipas, Veracruz, Puebla, Hidalgo, San Luis Potosi, Queretaro, and Guanajuato
        """)
        doc.add_tier(GeonameAnnotator())
        duplicate_spans = []
        span_starts = set()
        for span in doc.tiers['geonames'].spans:
            if span.start in span_starts:
                duplicate_spans.append(span)
            span_starts.add(span.start)
        self.assertEqual([unicode(s) for s in duplicate_spans], [])

if __name__ == '__main__':
    unittest.main()
